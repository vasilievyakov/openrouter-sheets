# 🔄 Визуализация потока работы системы

## Как работает система:

```
┌─────────────────────────────────────────────────────────────┐
│                    ПОЛЬЗОВАТЕЛЬ                              │
│                                                              │
│  1. Открывает Google Sheet                                   │
│  2. Видит меню "LLM Tools" → "Обработать новости"          │
│  3. Вводит промпт (например: "Определи бренд")              │
│  4. Нажимает OK                                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              GOOGLE APPS SCRIPT (main.gs)                   │
│                                                              │
│  • Проверяет наличие данных в таблице                       │
│  • Создает новую колонку с заголовком                      │
│  • Формирует payload:                                       │
│    {                                                         │
│      spreadsheetId: "...",                                  │
│      sheetName: "Sheet1",                                    │
│      prompt: "Определи бренд",                              │
│      columnIndex: 2,                                        │
│      totalRows: 10                                          │
│    }                                                         │
│  • Отправляет POST запрос на GitHub API                    │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │ POST https://api.github.com/repos/...
                       │ Authorization: token GITHUB_TOKEN
                       │ Body: {
                       │   event_type: "run-openrouter",
                       │   client_payload: { ... }
                       │ }
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              GITHUB API                                     │
│                                                              │
│  • Принимает repository_dispatch событие                   │
│  • Проверяет токен и права                                  │
│  • Триггерит GitHub Actions workflow                       │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│         GITHUB ACTIONS (.github/workflows/run.yml)          │
│                                                              │
│  1. Checkout repository                                    │
│  2. Setup Node.js 20                                        │
│  3. Install dependencies (npm ci)                          │
│  4. Setup Google Credentials                                │
│     • Создает google-credentials.json из Secret            │
│  5. Process Sheet                                           │
│     • Запускает: node index.js                              │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              NODE.JS СКРИПТ (index.js)                      │
│                                                              │
│  1. Читает GITHUB_EVENT_PATH                                │
│  2. Извлекает client_payload                                │
│  3. Инициализирует Google Sheets API                        │
│  4. Читает данные из таблицы (столбец A)                   │
│  5. Обрабатывает батчами (по 20 строк):                    │
│     ┌─────────────────────────────────────┐                 │
│     │ Для каждой строки:                 │                 │
│     │  • Отправляет запрос в OpenRouter  │                 │
│     │  • Получает ответ от LLM            │                 │
│     │  • Кэширует результат              │                 │
│     └─────────────────────────────────────┘                 │
│  6. Записывает результаты в новую колонку                  │
│  7. Повторяет для всех батчей                              │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ├─────────────────┐
                       ▼                 ▼
            ┌──────────────┐    ┌──────────────┐
            │ OpenRouter   │    │ Google Sheets│
            │    API       │    │     API      │
            └──────────────┘    └──────────────┘
                       │                 │
                       └────────┬────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │  РЕЗУЛЬТАТЫ В ТАБЛИЦЕ │
                    │                       │
                    │  Колонка заполнена    │
                    │  ответами от LLM      │
                    └───────────────────────┘
```

## Проверка системы - результаты:

✅ **GitHub Repository**: Существует и доступен
✅ **Apps Script код**: Корректно структурирован
✅ **Node.js скрипт**: Все компоненты на месте
✅ **GitHub Actions workflow**: Правильно настроен
✅ **Payload структура**: Корректна

⚠️ **Требуется настройка**:
- GITHUB_TOKEN в apps-script/config.gs (сейчас плейсхолдер)
- GitHub Secrets (OPENROUTER_KEY, GOOGLE_APPLICATION_CREDENTIALS)

## Что проверить вручную:

1. **Google Sheets**:
   - Код Apps Script скопирован
   - GITHUB_TOKEN заменен на реальный
   - Меню "LLM Tools" появляется

2. **GitHub Secrets**:
   - OPENROUTER_KEY добавлен
   - GOOGLE_APPLICATION_CREDENTIALS добавлен (весь JSON)

3. **Google Service Account**:
   - Таблица поделена с email Service Account
   - Права "Редактор" предоставлены

## Тестирование:

После настройки всех компонентов:

1. Откройте Google Sheet
2. LLM Tools → Обработать новости
3. Введите тестовый промпт
4. Проверьте GitHub Actions (должен запуститься workflow)
5. Через несколько минут проверьте результаты в таблице

